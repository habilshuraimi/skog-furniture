<%- include('../layout/header') %>


     <!-- search start -->
     <div class="search-content-wrap main-search-active">
        <a class="search-close"><i class="dlicon ui-1_simple-remove"></i></a>
        <div class="search-content">
            <p>Start typing and press Enter to search</p>
            <form class="search-form" action="#">
                <input type="text" placeholder="Search">
                <button class="button-search"><i class="dlicon ui-1_zoom"></i></button>
            </form>
        </div>
    </div>
    <!-- mini cart start -->
    <div class="sidebar-cart-active">
        <div class="sidebar-cart-all">
            <a class="cart-close" href="#"><i class="dlicon ui-1_simple-remove"></i></a>
            <div class="cart-content">
                <h3>Shopping Cart</h3>
                <ul>
                    <li class="single-product-cart">
                        <div class="cart-img">
                            <a href="#"><img src="assets/images/cart/cart-1.jpg" alt=""></a>
                        </div>
                        <div class="cart-title">
                            <h4><a href="#">Bejewelled velvet sandals</a></h4>
                            <span> 1 × $49.00	</span>
                        </div>
                        <div class="cart-delete">
                            <a href="#">×</a>
                        </div>
                    </li>
                    <li class="single-product-cart">
                        <div class="cart-img">
                            <a href="#"><img src="assets/images/cart/cart-2.jpg" alt=""></a>
                        </div>
                        <div class="cart-title">
                            <h4><a href="#">Contrast faux fur jacket</a></h4>
                            <span> 1 × $49.00	</span>
                        </div>
                        <div class="cart-delete">
                            <a href="#">×</a>
                        </div>
                    </li>
                </ul>
                <div class="cart-total">
                    <h4>Subtotal: <span>$170.00</span></h4>
                </div>
                <div class="cart-checkout-btn">
                    <a class="btn-hover cart-btn-style" href="cart.html">view cart</a>
                    <a class="no-mrg btn-hover cart-btn-style" href="checkout.html">checkout</a>
                </div>
            </div>
        </div>
    </div>
    <!-- aside start -->
    <div class="header-aside-active">
        <div class="header-aside-wrap">
            <a class="aside-close"><i class="dlicon ui-1_simple-remove"></i></a>
            <div class="header-aside-content">
                <div class="mobile-menu-area">
                    <div class="mobile-search">
                        <form class="search-form" action="#">
                            <input type="text" placeholder="Search entire store…">
                            <button class="button-search"><i class="dlicon ui-1_zoom"></i></button>
                        </form>
                    </div>
                    <div class="mobile-menu-wrap">
                        <!-- mobile menu start -->
                        <div class="mobile-navigation">
                            <!-- mobile menu navigation start -->
                            <nav>
                                <ul class="mobile-menu">
                                    <li class="menu-item-has-children"><a href="index.html">Home</a>
                                        <ul class="dropdown">
                                            <li class="menu-item-has-children"><a href="#">Demo Group 01</a>
                                                <ul class="dropdown">
                                                    <li><a href="index.html">Home 01</a></li>
                                                    <li><a href="index-2.html">Home 02</a></li>
                                                    <li><a href="index-3.html">Home 03</a></li>
                                                    <li><a href="index-4.html">Home 04</a></li>
                                                    <li><a href="index-5.html">Home 05</a></li>
                                                    <li><a href="index-6.html">Home 06</a></li>
                                                </ul>
                                            </li>
                                            <li class="menu-item-has-children"><a href="#">Demo Group 02</a>
                                                <ul class="dropdown">
                                                    <li><a href="index-7.html">Home 07</a></li>
                                                    <li><a href="index-8.html">Home 08</a></li>
                                                    <li><a href="index-9.html">Home 09</a></li>
                                                    <li><a href="index-10.html">Home 10</a></li>
                                                    <li><a href="index-11.html">Home 11</a></li>
                                                    <li><a href="index-12.html">Home 12</a></li>
                                                </ul>
                                            </li>
                                            <li class="menu-item-has-children"><a href="#">Demo Group 03</a>
                                                <ul class="dropdown">
                                                    <li><a href="index-13.html">Home 13</a></li>
                                                    <li><a href="index-14.html">Home 14</a></li>
                                                    <li><a href="index-15.html">Home 15</a></li>
                                                    <li><a href="index-16.html">Home 16</a></li>
                                                    <li><a href="index-17.html">Home 17</a></li>
                                                    <li><a href="index-18.html">Home 18</a></li>
                                                    <li><a href="index-19.html">Home 19</a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><a href="#">Pages</a>
                                        <ul class="dropdown">
                                            <li><a href="about-us.html">About Us</a></li>
                                            <li><a href="contact-us.html">Contact Page</a></li>
                                            <li><a href="404.html">404 Page</a></li>
                                            <li><a href="comming-soon.html">Comming Soon 01</a></li>
                                            <li><a href="comming-soon-2.html">Comming Soon 02</a></li>
                                            <li><a href="faq.html">FAQ</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children "><a href="shop-fullwide.html">shop</a>
                                        <ul class="dropdown">
                                            <li class="menu-item-has-children"><a href="#">Shop Layout</a>
                                                <ul class="dropdown">
                                                    <li><a href="shop-fullwide.html">Shop Fullwidth</a></li>
                                                    <li><a href="shop-sidebar.html">Shop Sidebar</a></li>
                                                    <li><a href="shop-metro.html">Shop Metro Layout</a></li>
                                                    <li><a href="shop-3-col.html">Shop 03 Columns</a></li>
                                                    <li><a href="shop-2-col.html">Shop 02 Columns</a></li>
                                                    <li><a href="shop-collection-1.html">Shop Collection 01</a></li>
                                                    <li><a href="shop-collection-2.html">Shop Collection 02</a></li>
                                                </ul>
                                            </li>
                                            <li class="menu-item-has-children"><a href="#">Product Layout</a>
                                                <ul class="dropdown">
                                                    <li><a href="product-details.html">Single 01</a></li>
                                                    <li><a href="product-details-2.html">Single 02</a></li>
                                                    <li><a href="product-details-group.html">Grouped</a></li>
                                                    <li><a href="product-details-sticky.html">Sticky Info</a></li>
                                                    <li><a href="product-details-configurable.html">Configurable</a></li>
                                                    <li><a href="product-details-thumbnail.html">Thumbnail</a></li>
                                                    <li><a href="product-details-video.html">Video</a></li>
                                                    <li><a href="product-details-affiliate.html">Affiliate</a></li>
                                                    <li><a href="product-details-sidebar.html">Sidebar</a></li>
                                                </ul>
                                            </li>
                                            <li class="menu-item-has-children"><a href="#">Shop Pages </a>
                                                <ul class="dropdown">
                                                    <li><a href="my-account.html">My Account</a></li>
                                                    <li><a href="checkout.html">Check Out</a></li>
                                                    <li><a href="cart.html">Shopping Cart</a></li>
                                                    <li><a href="wishlist.html">Wishlist</a></li>
                                                    <li><a href="order-tracking.html">Order Tracking</a></li>
                                                    <li><a href="compare.html">Compare</a></li>
                                                    <li><a href="login-register.html">login / register</a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children "><a href="shop-collection-1.html">Collection</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-collection-1.html">Shop Collection 01</a></li>
                                            <li><a href="shop-collection-2.html">Shop Collection 02</a></li>
                                            <li><a href="shop-metro.html">Shop Metro Layout</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children "><a href="blog.html">Blog</a>
                                        <ul class="dropdown">
                                            <li><a href="blog.html">Blog Style 01</a></li>
                                            <li><a href="blog-2.html">Blog Style 02</a></li>
                                            <li><a href="blog-3.html">Blog Style 03</a></li>
                                            <li><a href="blog-details.html">Single Post Style 01</a></li>
                                            <li><a href="blog-details-2.html">Single Post Style 02</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="shop-instagram.html">Instagram Shop </a></li>
                                </ul>
                            </nav>
                            <!-- mobile menu navigation end -->
                        </div>
                        <!-- mobile menu end -->
                    </div>
                    <div class="mobile-curr-lang-wrap">
                        <div class="single-mobile-curr-lang">
                            <a class="mobile-language-active" href="#">Language <i class="fa fa-angle-down"></i></a>
                            <div class="lang-curr-dropdown lang-dropdown-active">
                                <ul>
                                    <li><a href="#">English (US)</a></li>
                                    <li><a href="#">English (UK)</a></li>
                                    <li><a href="#">Spanish</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="single-mobile-curr-lang">
                            <a class="mobile-currency-active" href="#">Currency <i class="fa fa-angle-down"></i></a>
                            <div class="lang-curr-dropdown curr-dropdown-active">
                                <ul>
                                    <li><a href="#">USD</a></li>
                                    <li><a href="#">EUR</a></li>
                                    <li><a href="#">Real</a></li>
                                    <li><a href="#">BDT</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="single-mobile-curr-lang">
                            <a class="mobile-account-active" href="#">My Account <i class="fa fa-angle-down"></i></a>
                            <div class="lang-curr-dropdown account-dropdown-active">
                                <ul>
                                    <li><a href="#">Login</a></li>
                                    <li><a href="#">Creat Account</a></li>
                                    <li><a href="my-account.html">My Account</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="header-aside-menu">
                    <nav>
                        <ul>
                            <li><a href="#">About Toro</a></li>
                            <li><a href="#">Help Center</a></li>
                            <li><a href="#">Collection</a></li>
                            <li><a href="#">Blog</a></li>
                            <li><a href="#">New Look</a></li>
                        </ul>
                    </nav>
                </div>
                <img src="assets/images/icon-img/payments.png" alt="payment">
                <p>Pellentesque mollis nec orci id tincidunt. Sed mollis risus eu nisi aliquet, sit amet fermentum justo dapibus.</p>
                <div class="aside-contact-info">
                    <ul>
                        <li><i class="dlicon ui-2_time-clock"></i>Monday - Friday: 9:00 - 19:00</li>
                        <li><i class="dlicon ui-1_email-84"></i>Info@la-studioweb.com</li>
                        <li><i class="dlicon tech-2_rotate"></i>(+55) 254. 254. 254</li>
                        <li><i class="dlicon ui-1_home-minimal"></i>Helios Tower 75 Tam Trinh Hoang - Ha Noi - Viet Nam</li>
                    </ul>
                </div>
                <div class="social-icon-style mb-25">
                    <a class="facebook" href="#"><i class="fa fa-facebook"></i></a>
                    <a class="twitter" href="#"><i class="fa fa-twitter"></i></a>
                    <a class="google-plus" href="#"><i class="fa fa-google-plus"></i></a>
                    <a class="behance" href="#"><i class="fa fa-behance"></i></a>
                </div>
                <div class="copyright">
                    <p>© 2021 <a href="https://hasthemes.com/">Toro.</a> All rights reserved</p>
                </div>
            </div>
        </div>
    </div>
    <div class="breadcrumb-area section-padding-1 bg-gray breadcrumb-ptb-1">
        <div class="container-fluid">
            <div class="breadcrumb-content text-center">
                <div class="breadcrumb-title">
                    <h2>Checkout</h2>
                </div>
                <ul>
                    <li>
                        <a href="index.html">Home  </a>
                    </li>
                    <li><span> &gt; </span></li>
                    <li class="active">Checkout </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- checkout start -->
    <div class="checkout-main-area pt-100 pb-100">
        <div class="container">
            <div class="customer-zone mb-30">
                <p class="cart-page-title">Have a coupon? <a class="checkout-click" href="#">Click here to enter your code</a></p>
                <div class="checkout-login-info">
                    <p>If you have a coupon code, please apply it below.</p>
                    <form action="#">
                        <input type="text" placeholder="Coupon code">
                        <input type="submit" value="Apply Coupon">
                    </form>
                </div>
            </div>
            <div class="checkout-wrap">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="billing-info-wrap mr-100">
                            <div class="row">
                                <div class="col-12 col-md-8 offset-md-2"> 
                                    <div class="card mt-4">
                                        <div class="card-header bg-primary text-white">
                                            <h3>Select Delivery Address</h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="address-list">
                                                <% if (addresses && addresses.length > 0) { %>
                                                    <% addresses.forEach((address, index) => { %>
                                                        <div class="address-item mb-3 p-3 border rounded">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" id="address<%= index %>" name="address" value="<%= address.addressType %>">
                                                                <label class="form-check-label" for="address<%= index %>">
                                                                    <strong><%= address.name %></strong><br>
                                                                    <%= address.type %>
                                                                    <%= address.houseNo %>, <%= address.street %><br>
                                                                    <%= address.landmark %><br>
                                                                    <%= address.city %>, <%= address.state %> - <%= address.pincode %><br>
                                                                    Phone: <%= address.mobile %>
                                                                </label>
                                                            </div>
                                                        </div>
                                                    <% }); %>
                                                <% } else { %>
                                                    <p>No saved addresses. Please add a new address.</p>
                                                <% } %>
                                            </div>
                                            <button id="addNewAddress" class="btn btn-success mt-3">Add New Address</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <style>
                                .address-item:hover {
                                    background-color: #f8f9fa;
                                }
                            </style>

                            <br>
                            
                            
                            
                           
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="your-order-area">
                            <h3>Your order</h3>
                            <div class="your-order-wrap gray-bg-4">
                                <div class="your-order-info-wrap">
                                    <div class="your-order-info">
                                        <ul>
                                            <li>Product <span>Total</span></li>
                                        </ul>
                                    </div>
                                    <div class="your-order-middle">
                                        <ul>
                                            <% let subtotal = 0; %>
                                            <% cartData.items.forEach(item => { %>
                                                <% const itemTotal = item.price * item.quantity; %>
                                                <% subtotal += itemTotal; %>
                                                <li>
                                                    <%= item.productId.name %> (Qty: <%= item.quantity %>)
                                                    <span>$<%= itemTotal / 100 .toFixed(2) %></span>
                                                </li>
                                            <% }); %>
                                        </ul>
                                    </div>
                                    <div class="your-order-info order-subtotal">
                                        <ul>
                                            <li>Subtotal <span>$<%= subtotal.toFixed(2) %></span></li>
                                        </ul>
                                    </div>
                                    
                                        <div class="your-order-info order-shipping">
                                            <ul>
                                                <li>Shipping <span>$ 0.00</span></li>
                                            </ul>
                                        </div>
                                    
                                    <% const discount = cartData.discountPrice || 0; %>
                                    <% if (discount > 0) { %>
                                        <div class="your-order-info order-discount">
                                            <ul>
                                                <li>Discount <span>-$<%= discount.toFixed(2) %></span></li>
                                            </ul>
                                        </div>
                                    <% } %>
                                    <div class="your-order-info order-total" >
                                        <ul >
                                            <li>Total <span >$<%= (subtotal - discount).toFixed(2) %></span></li>
                                            <input  type="hidden" value="<%= (subtotal - discount).toFixed(2) %>" name="amount">
                                        </ul>
                                    </div>
                                </div>
                                <div style="margin-top: 20px;">
                                    <label for="payOnDelivery" style="font-family: Arial, sans-serif; font-size: 16px;">
                                        <input type="checkbox" id="paymentOption" name="paymentOption" value="COD" style="margin-right: 10px;">
                                        Pay on Delivery
                                    </label>
                                </div>
                                
                                
                                
                            <div class="Place-order mt-30">
                                <button id="proceedButton"> Place Order</button> 
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('proceedButton').addEventListener("click", async (e) => {
            e.preventDefault(); // Prevent form from submitting traditionally
        
            const selectedAddressType = document.querySelector('input[name="address"]:checked');
            const selectedPaymentOption = document.querySelector('input[name="paymentOption"]:checked');
            const bill=     document.querySelector('input[name="amount"]').value
            console.log(bill,)
            if (!selectedAddressType || !selectedPaymentOption) {
                Swal.fire({
                    title: 'Attention!',
                    text: 'Please select both an address and a payment option.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                return;
            }
        
            const addressType = selectedAddressType.value;
            const paymentOption = selectedPaymentOption.value;
            const billValue=bill.replace('Rs','').replace('.00','').trim();
           console.log(billValue)
            const amount=parseFloat(billValue);
           console.log(amount,"amount")
        
            const data = { addressType, paymentOption,amount};
            
            try {
                if(paymentOption=='COD'){
                const response = await fetch('/order', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
        
                if (response.ok) {
                    const responseData = await response.json(); // Assuming the server responds with JSON
                    // Handle success. You might want to redirect the user or display a success message
                    Swal.fire({
                        title: 'Success!',
                        text: 'Order placed successfully.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then((result) => {
                        if (result.isConfirmed) {
                           window.location.href =`/confirmOrder?id=${responseData.order_id}`;
                           // Redirect to confirmation page, adjust URL as needed
                        }
                    });
                }
            
        
        }
         else {
                    // The server responded with a status outside the range 200-299
                    throw new Error('The server responded with an error status.')
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'An error occurred during order placement. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                })
            }
        
                   } )
        
            </script>
    <%-include('../layout/footer') %>